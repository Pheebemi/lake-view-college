{% extends 'layout/applicant.html' %}

{% load static %}

{% block late %}
    <!-- Messages Block -->
    {% if messages %}
        <div class="fixed top-4 right-4 z-50 space-y-2 max-w-sm">
            {% for message in messages %}
                <div class="px-4 py-3 rounded-lg shadow-lg text-white font-medium text-sm
                            {% if message.tags == 'success' %}bg-green-500{% endif %}
                            {% if message.tags == 'error' %}bg-red-500{% endif %}
                            {% if message.tags == 'warning' %}bg-yellow-500{% endif %}
                            {% if message.tags == 'info' %}bg-blue-500{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Application Status Card -->
    <div class="py-6 px-4 sm:px-6 lg:px-8 mt-16 lg:mt-0">
        <div class="max-w-7xl mx-auto">
            <!-- Welcome Header -->
            <div class="text-center mb-8">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">Welcome, {{ user.get_full_name }}!</h1>
                <p class="text-gray-600">Track your application progress and manage your information</p>
            </div>

            <!-- Application Status Card -->
            <div class="bg-white overflow-hidden shadow-lg rounded-xl mb-6">
                <div class="px-4 py-5 sm:p-6">
                    <div class="flex items-center mb-4">
                        <div class="bg-blue-100 w-10 h-10 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-clipboard-check text-blue-600"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">Application Status</h3>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-500 mb-1">Program Applied</p>
                                <p class="text-lg font-semibold text-gray-900">{{ applicant.programs.name }}</p>
                            </div>
                            <div class="mt-3 sm:mt-0 sm:ml-4">
                                {% if applicant.status == 'pending_review' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold text-yellow-800 bg-yellow-100 border border-yellow-200">
                                        <i class="fas fa-clock mr-2"></i>
                                        Pending Review
                                    </span>
                                {% elif applicant.status == 'approved' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold text-green-800 bg-green-100 border border-green-200">
                                        <i class="fas fa-check-circle mr-2"></i>
                                        Approved
                                    </span>
                                {% elif applicant.status == 'rejected' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold text-red-800 bg-red-100 border border-red-200">
                                        <i class="fas fa-times-circle mr-2"></i>
                                        Rejected
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold text-red-800 bg-red-100 border border-red-200">
                                        <i class="fas fa-exclamation-circle mr-2"></i>
                                        Not Applied
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="mt-4">
                            <div class="flex items-center justify-between text-sm text-gray-600 mb-2">
                                <span>Application Progress</span>
                                <span>{% if applicant.status != 'not_applied' %}100%{% else %}0%{% endif %}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full transition-all duration-500" 
                                     style="width: {% if applicant.status != 'not_applied' %}100%{% else %}0%{% endif %}"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Application Details -->
            <div class="bg-white shadow-lg overflow-hidden rounded-xl">
                <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                    <div class="flex items-center">
                        <div class="bg-green-100 w-10 h-10 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-user text-green-600"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">Application Details</h3>
                    </div>
                </div>
                
                <div class="divide-y divide-gray-200">
                    <div class="bg-gray-50 px-4 py-4 sm:px-6">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <dt class="text-sm font-medium text-gray-500">Full Name</dt>
                            <dd class="text-sm text-gray-900 sm:col-span-2 font-medium">
                                {{ user.get_full_name }}
                            </dd>
                        </div>
                    </div>
                    
                    <div class="bg-white px-4 py-4 sm:px-6">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <dt class="text-sm font-medium text-gray-500">Mode of Entry</dt>
                            <dd class="text-sm text-gray-900 sm:col-span-2 font-medium">
                                {{ applicant.mode }}
                            </dd>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 px-4 py-4 sm:px-6">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <dt class="text-sm font-medium text-gray-500">State of Origin</dt>
                            <dd class="text-sm text-gray-900 sm:col-span-2 font-medium">
                                {{ applicant.state }}
                            </dd>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- Action Buttons -->
            <div class="mt-8 text-center">
                {% if applicant.status == 'not_applied' %}
                    <!-- Check if applicant has paid for screening form -->
                    {% if has_paid_screening_fee %}
                        <a href="{% url 'core:screening_form' %}" 
                           class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 shadow-lg">
                            <i class="fas fa-file-alt mr-2"></i>
                            Complete Screening Form
                        </a>
                    {% else %}
                        <!-- Payment Required -->
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 max-w-md mx-auto mb-6">
                            <div class="flex items-center">
                                <i class="fas fa-lock text-yellow-600 mr-3 text-xl"></i>
                                <div>
                                    <p class="text-yellow-800 font-medium">Payment Required</p>
                                    <p class="text-yellow-600 text-sm">You need to pay ₦{{ screening_fee|floatformat:0 }} ({{ applicant.programs.get_program_type_display }}) to access the screening form.</p>
                                </div>
                            </div>
                        </div>
                        
                        <a href="{% url 'core:screening_payment_wall' %}" 
                           class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-200 shadow-lg">
                            <i class="fas fa-credit-card mr-2"></i>
                            Pay ₦{{ screening_fee|floatformat:0 }} & Access Form
                        </a>
                    {% endif %}
                {% else %}
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 max-w-md mx-auto mb-6">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-blue-600 mr-3 text-xl"></i>
                            <div>
                                <p class="text-blue-800 font-medium">Form Submitted!</p>
                                <p class="text-blue-600 text-sm">Your screening form has been submitted and is under review.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Print Form Button -->
                    <button onclick="printScreeningForm()" 
                            class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-200 shadow-lg">
                        <i class="fas fa-print mr-2"></i>
                        Print Screening Form
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
    
    <script>
        // Custom Alert Function
        function showAlert(message, type = 'error') {
            // Create alert container if it doesn't exist
            let alertContainer = document.querySelector('.custom-alert-container');
            if (!alertContainer) {
                alertContainer = document.createElement('div');
                alertContainer.className = 'custom-alert-container fixed top-4 right-4 z-50 space-y-2 max-w-sm';
                document.body.appendChild(alertContainer);
            }

            // Create alert element
            const alert = document.createElement('div');
            alert.className = `px-4 py-3 rounded-lg shadow-lg text-white font-medium text-sm transform transition-all duration-300 ease-in-out ${
                type === 'success' ? 'bg-green-500' :
                type === 'warning' ? 'bg-yellow-500' :
                type === 'info' ? 'bg-blue-500' :
                'bg-red-500'
            }`;
            alert.style.opacity = '0';
            alert.style.transform = 'translateX(100%)';
            alert.innerHTML = `
                <div class="flex items-start">
                    <i class="fas ${
                        type === 'success' ? 'fa-check-circle' :
                        type === 'warning' ? 'fa-exclamation-triangle' :
                        type === 'info' ? 'fa-info-circle' :
                        'fa-exclamation-circle'
                    } mr-2 mt-0.5"></i>
                    <span>${message}</span>
                </div>
            `;

            alertContainer.appendChild(alert);

            // Animate in
            setTimeout(() => {
                alert.style.opacity = '1';
                alert.style.transform = 'translateX(0)';
            }, 10);

            // Auto dismiss after 5 seconds
            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    alert.remove();
                    // Remove container if no more alerts
                    if (alertContainer.children.length === 0) {
                        alertContainer.remove();
                    }
                }, 300);
            }, 5000);
        }

        // Automatically dismiss messages after 5 seconds
        document.addEventListener('DOMContentLoaded', function() {
            let messages = document.querySelectorAll('.fixed.top-4.right-4.z-50 > div');
            messages.forEach(function(message) {
                setTimeout(function() {
                    message.style.opacity = '0';
                    message.style.transform = 'translateX(100%)';
                    setTimeout(function() {
                        message.remove();
                    }, 300);
                }, 5000); // 5 seconds
            });
        });

        // Function to print screening form
        function printScreeningForm() {
            // Show loading state
            const printButton = event.target;
            const originalText = printButton.innerHTML;
            printButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
            printButton.disabled = true;
            
            // Fetch screening form data
            fetch('{% url "core:get_screening_form_data" %}')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showAlert('Error: ' + data.error, 'error');
                        printButton.innerHTML = originalText;
                        printButton.disabled = false;
                        return;
                    }
                    
                    // Create a new window for printing
                    const printWindow = window.open('', '_blank', 'width=900,height=700');
                    
                    // Determine programme type
                    const getProgrammeType = () => {
                        let pt = data.applicant_info?.program_type || data.program_type || data.form_data?.program_type || data.applicant_info?.program || data.applicant_info?.program_name || data.applicant_info?.course || '';
                        const ptl = pt.toLowerCase();
                        if (ptl.includes('degree') || ptl.includes('b.ed') || ptl.includes('bachelor')) return 'DEGREE PROGRAMME';
                        if (ptl.includes('nce') || ptl.includes('national certificate')) return 'NCE PROGRAMME';
                        if (ptl.includes('diploma') || ptl.includes('dip')) return 'DIPLOMA PROGRAMME';
                        return pt ? pt.toUpperCase() + ' PROGRAMME' : 'PROGRAMME';
                    };

                    const printContent = `
                        <!DOCTYPE html>
                        <html lang="en">
                        <head>
                            <meta charset="UTF-8">
                            <title>Screening Form - ${data.applicant_info.name}</title>
                            <style>
                                @page { size: A4; margin: 8mm 12mm; }
                                @media print {
                                    html, body { width: 210mm; height: 297mm; margin: 0; padding: 0; overflow: hidden; }
                                    .no-print { display: none !important; }
                                }
                                * { margin: 0; padding: 0; box-sizing: border-box; }
                                body { font-family: 'Times New Roman', Times, serif; font-size: 11px; line-height: 1.3; color: #000; max-width: 800px; margin: 0 auto; padding: 15px; background: white; }
                                .header { text-align: center; margin-bottom: 8px; }
                                .header img { width: 60px; height: 60px; display: block; margin: 0 auto 5px; }
                                .school-name { font-size: 20px; font-weight: bold; text-transform: uppercase; }
                                .school-tagline { font-size: 12px; font-style: italic; }
                                .form-title { font-size: 15px; font-weight: bold; margin-top: 6px; }
                                .programme-badge { font-size: 11px; font-weight: bold; margin-top: 4px; }
                                .section-heading { text-align: center; font-weight: bold; font-size: 12px; margin: 10px 0 4px; text-transform: uppercase; border-bottom: 1px solid #000; padding-bottom: 2px; }
                                .detail-table { width: 100%; border-collapse: collapse; margin-bottom: 2px; }
                                .detail-table td { padding: 3px 6px; border-bottom: 1px dashed #bbb; vertical-align: top; font-size: 10px; }
                                .detail-table .label { font-weight: bold; width: 110px; white-space: nowrap; text-transform: uppercase; font-size: 9px; }
                                .detail-table .value { min-width: 100px; }
                                .sub-heading { font-weight: bold; font-size: 10px; margin: 6px 0 2px; text-transform: uppercase; }
                                table.subjects { width: 100%; border-collapse: collapse; font-size: 10px; margin-bottom: 2px; }
                                table.subjects th, table.subjects td { border: 1px solid #000; padding: 2px 6px; text-align: left; }
                                table.subjects th { background: #f0f0f0; font-size: 9px; text-align: center; }
                                td.center { text-align: center; }
                                .signatures { margin-top: 15px; font-size: 11px; }
                                .sig-line { margin-bottom: 10px; }
                                .sig-line span { font-weight: bold; }
                                .footer { text-align: center; margin-top: 10px; font-size: 9px; color: #888; border-top: 1px solid #ddd; padding-top: 4px; }
                                .print-btn { position: fixed; top: 20px; right: 20px; padding: 10px 20px; background: #059669; color: white; border: none; border-radius: 6px; font-weight: bold; font-size: 14px; cursor: pointer; z-index: 1000; }
                                .print-btn:hover { background: #047857; }
                            </style>
                        </head>
                        <body>
                            <button class="print-btn no-print" onclick="window.print()">Print Screening Form</button>

                            <div class="header">
                                <img src="{% static 'assets/images/logos/lakeview.jpg' %}" alt="Logo">
                                <div class="school-name">LakeView College of Education</div>
                                <div class="school-tagline">...Centre of Excellence</div>
                                <div class="form-title">SCREENING FORM</div>
                                <div class="programme-badge">${getProgrammeType()}</div>
                            </div>

                            <div class="section-heading">Personal Information</div>
                            <table class="detail-table">
                                <tr>
                                    <td class="label">Surname</td>
                                    <td class="value">${(data.personal_info.surname || 'N/A').toUpperCase()}</td>
                                    <td class="label">First Name</td>
                                    <td class="value">${(data.personal_info.first_name || 'N/A').toUpperCase()}</td>
                                </tr>
                                <tr>
                                    <td class="label">Middle Name</td>
                                    <td class="value">${(data.personal_info.middle_name || 'N/A').toUpperCase()}</td>
                                    <td class="label">Sex</td>
                                    <td class="value">${data.personal_info.sex}</td>
                                </tr>
                                <tr>
                                    <td class="label">Date of Birth</td>
                                    <td class="value">${data.personal_info.date_of_birth}</td>
                                    <td class="label">State of Origin</td>
                                    <td class="value">${data.personal_info.state_of_origin}</td>
                                </tr>
                                <tr>
                                    <td class="label">Local Govt</td>
                                    <td class="value">${data.personal_info.local_government}</td>
                                    <td class="label">Phone</td>
                                    <td class="value">${data.personal_info.phone_number}</td>
                                </tr>
                                <tr>
                                    <td class="label">Email</td>
                                    <td class="value">${data.personal_info.email}</td>
                                    <td class="label">Address</td>
                                    <td class="value">${data.personal_info.contact_address}</td>
                                </tr>
                            </table>

                            <div class="section-heading">JAMB & Academic Background</div>
                            <table class="detail-table">
                                <tr>
                                    <td class="label">JAMB Reg No</td>
                                    <td class="value">${data.jamb_details.jamb_reg_no || 'N/A'}</td>
                                    <td class="label">JAMB Score</td>
                                    <td class="value">${data.jamb_details.jamb_score || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td class="label">Primary School</td>
                                    <td class="value">${data.academic_info.primary_school || 'N/A'}</td>
                                    <td class="label">Dates</td>
                                    <td class="value">${data.academic_info.primary_school_dates || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td class="label">Secondary School</td>
                                    <td class="value">${data.academic_info.secondary_school || 'N/A'}</td>
                                    <td class="label">Dates</td>
                                    <td class="value">${data.academic_info.secondary_school_dates || 'N/A'}</td>
                                </tr>
                            </table>

                            <div class="section-heading">Examination Details</div>
                            <table class="detail-table">
                                <tr>
                                    <td class="label">1st Sitting Type</td>
                                    <td class="value">${data.examination_details.first_sitting.exam_type}</td>
                                    <td class="label">Exam No</td>
                                    <td class="value">${data.examination_details.first_sitting.exam_number}</td>
                                </tr>
                                <tr>
                                    <td class="label">1st Sitting Year</td>
                                    <td class="value">${data.examination_details.first_sitting.exam_year}</td>
                                    <td class="label"></td>
                                    <td class="value"></td>
                                </tr>
                                <tr>
                                    <td class="label">2nd Sitting Type</td>
                                    <td class="value">${data.examination_details.second_sitting.exam_type || 'N/A'}</td>
                                    <td class="label">Exam No</td>
                                    <td class="value">${data.examination_details.second_sitting.exam_number || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td class="label">2nd Sitting Year</td>
                                    <td class="value">${data.examination_details.second_sitting.exam_year || 'N/A'}</td>
                                    <td class="label"></td>
                                    <td class="value"></td>
                                </tr>
                            </table>

                            <div class="sub-heading">First Sitting Subjects</div>
                            <table class="subjects">
                                <thead>
                                    <tr>
                                        <th style="width:30px;">SN</th>
                                        <th>Subject</th>
                                        <th style="width:60px;">Grade</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.subjects.first_sitting.map((s, i) =>
                                        '<tr><td class="center">' + (i+1) + '</td><td>' + s.subject + '</td><td class="center">' + s.grade + '</td></tr>'
                                    ).join('')}
                                </tbody>
                            </table>

                            ${data.subjects.second_sitting.length > 0 ? `
                                <div class="sub-heading">Second Sitting Subjects</div>
                                <table class="subjects">
                                    <thead>
                                        <tr>
                                            <th style="width:30px;">SN</th>
                                            <th>Subject</th>
                                            <th style="width:60px;">Grade</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.subjects.second_sitting.map((s, i) =>
                                            '<tr><td class="center">' + (i+1) + '</td><td>' + s.subject + '</td><td class="center">' + s.grade + '</td></tr>'
                                        ).join('')}
                                    </tbody>
                                </table>
                            ` : ''}

                            <div class="section-heading">Programme Choices</div>
                            <table class="detail-table">
                                <tr>
                                    <td class="label">1st Choice</td>
                                    <td class="value">${data.program_choices.first_choice}</td>
                                    <td class="label">2nd Choice</td>
                                    <td class="value">${data.program_choices.second_choice}</td>
                                </tr>
                                <tr>
                                    <td class="label">3rd Choice</td>
                                    <td class="value">${data.program_choices.third_choice}</td>
                                    <td class="label"></td>
                                    <td class="value"></td>
                                </tr>
                            </table>

                            <div class="signatures">
                                <div class="sig-line"><span>APPLICANT'S SIGNATURE:</span> ..............................................................................................................................................................................................</div>
                                <div class="sig-line"><span>DATE:</span> ..........................................................................................................................................................................................................................</div>
                            </div>

                            <div class="footer">
                                This screening form was generated from LakeView College portal.
                            </div>
                        </body>
                        </html>
                    `;
                    
                    // Write content to the new window
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                    
                    // Wait for content to load then focus
                    printWindow.onload = function() {
                        printWindow.focus();
                    };
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error loading form data. Please try again.', 'error');
                })
                .finally(() => {
                    // Restore button state
                    printButton.innerHTML = originalText;
                    printButton.disabled = false;
                });
        }
    </script>
{% endblock %}